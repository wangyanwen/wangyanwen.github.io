+++
date = '2025-08-15T16:03:46+02:00'
draft = false
title = '使用树莓派4B搭配磁盘阵列，打造苹果时间机器备份服务器'
+++

## 使用树莓派4B搭配磁盘阵列，打造苹果时间机器备份服务器

本文将详细介绍如何利用树莓派4B和磁盘阵列，构建一个稳定、可靠且经济实惠的苹果时间机器（Time Machine）网络备份解决方案。通过本教程，您可以将您的Mac数据自动备份到由多块硬盘组成的冗余存储池中，从而有效保护您的数据安全。

### 核心优势

- **数据冗余与安全**: 利用磁盘阵列（RAID），即使其中一块硬盘损坏，您的备份数据也能安然无恙（取决于您选择的RAID级别）。
    
- **低功耗与静音**: 树莓派4B以其极低的功耗和无风扇设计，可以7x24小时不间断运行，且不会产生恼人的噪音。
    
- **高性价比**: 相比于市面上的成品NAS（网络附加存储），此DIY方案成本更低，且具有更高的灵活性和可定制性。
    
- **自动化备份**: 一旦设置完成，您的Mac将在接入同一网络时自动进行增量备份，无需人工干预。
    

---

### 准备工作

在开始之前，请确保您已准备好以下硬件和软件：

**硬件清单:**

- **树莓派4B**: 建议选择4GB或更高内存的版本，以获得更佳性能。
    
- **磁盘阵列外壳**: 选择一个支持多块硬盘（至少2块）并带有独立电源的USB磁盘阵列盒。确保其与树莓派4B的USB 3.0接口兼容。
    
- **硬盘**: 2块或以上相同容量的机械硬盘（HDD）或固态硬盘（SSD）。
    
- **MicroSD卡**: 至少16GB，用于安装树莓派操作系统。
    
- **树莓派电源**: 官方推荐的5V/3A USB-C电源适配器。
    
- **以太网线**: 用于将树莓派连接到您的路由器。
    
- **（可选）树莓派外壳和散热片**: 保护树莓派并帮助其散热。
    

**软件清单:**

- **Raspberry Pi OS**: 推荐安装最新的64位桌面版或Lite版。
    
- **mdadm**: 用于在Linux上创建和管理软件RAID的工具。
    
- **Samba**: 用于创建网络共享，使Mac可以访问。
    
- **Avahi**: 用于服务发现，让您的Mac能够自动找到时间机器服务器。
    

---

### 操作步骤

#### 第一步：安装和配置树莓派OS

1. **烧录操作系统**: 使用Raspberry Pi Imager工具将最新的Raspberry Pi OS烧录到您的MicroSD卡中。在烧录过程中，建议提前设置好SSH访问和Wi-Fi连接（如果使用无线网络）。
    
2. **启动树莓派**: 将MicroSD卡插入树莓派，连接好磁盘阵列（暂时不要插入硬盘）、网线和电源，启动树莓派。
    
3. **系统更新**: 通过SSH连接到您的树莓派，或者直接连接显示器和键盘，打开终端并执行以下命令更新系统：
    
    Bash
    
    ```
    sudo apt update
    sudo apt upgrade -y
    ```
    

#### 第二步：设置磁盘阵列（RAID）

1. **安装mdadm**: 在终端中输入以下命令安装RAID管理工具：
    
    Bash
    
    ```
    sudo apt install mdadm -y
    ```
    
2. **识别硬盘**: 将准备好的硬盘插入磁盘阵列盒，并连接到树莓派的USB 3.0接口。然后使用以下命令查看硬盘设备名称：
    
    Bash
    
    ```
    lsblk
    ```
    
    您应该能看到类似 `/dev/sda`, `/dev/sdb` 等设备。请务必确认这些是您新插入的硬盘。
    
3. **创建RAID阵列**: 本教程以创建RAID 1（镜像）为例，它提供了数据冗余。如果您有两块硬盘（例如 `/dev/sda` 和 `/dev/sdb`），请执行以下命令：
    
    Bash
    
    ```
    sudo mdadm --create --verbose /dev/md0 --level=1 --raid-devices=2 /dev/sda /dev/sdb
    ```
    
    - `/dev/md0`: 这是您创建的RAID设备的名称。
        
    - `--level=1`: 指定RAID级别为RAID 1。
        
    - `--raid-devices=2`: 指定用于创建阵列的设备数量。
        
    - `/dev/sda /dev/sdb`: 您的硬盘设备名称。
        
    
    创建过程可能需要一些时间，具体取决于您的硬盘大小。您可以使用以下命令查看进度：
    
    Bash
    
    ```
    cat /proc/mdstat
    ```
    
4. **保存RAID配置**: 为了让系统在重启后能自动识别RAID阵列，需要将配置保存到文件中：
    
    Bash
    
    ```
    sudo mdadm --detail --scan | sudo tee -a /etc/mdadm/mdadm.conf
    ```
    
5. **创建文件系统**: 在新创建的RAID设备上创建文件系统。推荐使用`ext4`格式：
    
    Bash
    
    ```
    sudo mkfs.ext4 /dev/md0
    ```
    
6. **挂载RAID阵列**: 创建一个挂载点并挂载您的RAID设备：
    
    Bash
    
    ```
    sudo mkdir -p /mnt/timemachine
    sudo mount /dev/md0 /mnt/timemachine
    ```
    
7. **设置自动挂载**: 为了在系统启动时自动挂载RAID阵列，需要编辑`/etc/fstab`文件：
    
    Bash
    
    ```
    sudo nano /etc/fstab
    ```
    
    在文件末尾添加以下行：
    
    ```
    /dev/md0 /mnt/timemachine ext4 defaults,nofail 0 0
    ```
    
    保存并关闭文件。
    

#### 第三步：安装和配置Samba

1. **安装Samba**:
    
    Bash
    
    ```
    sudo apt install samba -y
    ```
    
2. **创建时间机器用户**: 创建一个专门用于时间机器备份的用户，并设置密码：
    
    Bash
    
    ```
    sudo adduser tmuser
    ```
    
    然后将该用户添加到Samba中：
    
    Bash
    
    ```
    sudo smbpasswd -a tmuser
    ```
    
3. **配置Samba共享**: 编辑Samba的配置文件：
    
    Bash
    
    ```
    sudo nano /etc/samba/smb.conf
    ```
    
    在文件的末尾添加以下内容：
    
    Ini, TOML
    
    ```
    [TimeMachine]
    comment = Time Machine Backup
    path = /mnt/timemachine
    valid users = tmuser
    read only = no
    vfs objects = catia fruit streams_xattr
    fruit:time machine = yes
    ```
    
    - **[TimeMachine]**: 共享的名称。
        
    - **path**: 您之前创建的挂载点。
        
    - **valid users**: 允许访问该共享的用户。
        
    - **vfs objects = catia fruit streams_xattr**: 这是为了更好地兼容macOS的关键配置。
        
    - **fruit:time machine = yes**: 将此共享声明为时间机器兼容。
        
4. **重启Samba服务**:
    
    Bash
    
    ```
    sudo systemctl restart smbd
    ```
    

#### 第四步：安装和配置Avahi

为了让您的Mac能自动在网络上发现这个时间机器服务器，我们需要安装并配置Avahi。

1. **安装Avahi**:
    
    Bash
    
    ```
    sudo apt install avahi-daemon -y
    ```
    
2. **创建Avahi服务文件**: 创建一个新的服务文件来广播时间机器服务：
    
    Bash
    
    ```
    sudo nano /etc/avahi/services/smb.service
    ```
    
    将以下内容粘贴到文件中：
    
    XML
    
    ```
    <?xml version="1.0" standalone='no'?>
    <!DOCTYPE service-group SYSTEM "avahi-service.dtd">
    <service-group>
        <name replace-wildcards="yes">%h</name>
        <service>
            <type>_smb._tcp</type>
            <port>445</port>
        </service>
        <service>
            <type>_device-info._tcp</type>
            <port>0</port>
            <txt-record>model=TimeCapsule</txt-record>
        </service>
    </service-group>
    ```
    
3. **重启Avahi服务**:
    
    Bash
    
    ```
    sudo systemctl restart avahi-daemon
    ```
    

---

### 第五步：在Mac上设置时间机器

1. **连接到服务器**: 在您的Mac上，打开“访达”（Finder），在菜单栏中选择“前往” > “连接服务器”（或使用快捷键 `Command + K`）。
    
2. **输入地址**: 在服务器地址栏中输入 `smb://<树莓派的IP地址>`，然后点击“连接”。
    
3. **身份验证**: 在弹出的窗口中，输入您之前创建的`tmuser`的用户名和密码。
    
4. **配置时间机器**:
    
    - 打开“系统偏好设置” > “时间机器”。
        
    - 点击“选择磁盘...”。
        
    - 您应该能看到您在树莓派上创建的名为“TimeMachine”的共享磁盘。
        
    - 选择该磁盘，并勾选“加密备份”（强烈推荐）。
        
    - 点击“使用磁盘”。系统会再次要求您输入`tmuser`的凭据。
        

至此，您的Mac就会开始第一次备份。首次备份可能需要较长时间，具体取决于您的数据量。之后的备份将是增量备份，速度会快很多。

### 总结

通过以上步骤，您已经成功地将一台树莓派4B和磁盘阵列配置成了一个功能强大的苹果时间机器服务器。这不仅为您提供了一个安全可靠的数据备份方案，也让您体验到了DIY的乐趣和灵活性。现在，您可以高枕无忧，让这台默默无闻的小电脑守护您的珍贵数据。